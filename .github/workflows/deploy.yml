name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

env:
  HUGO_VERSION: '0.154.5'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      - name: Cache Hugo modules
        uses: actions/cache@v4
        with:
          path: /tmp/hugo_cache
          key: ${{ runner.os }}-hugomod-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-hugomod-

      - name: Build
        env:
          HUGO_CACHEDIR: /tmp/hugo_cache
        run: hugo --gc --minify

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hugo-site
          path: public/
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: hugo-site
          path: public/

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare Pages
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set +e
          OUTPUT=$(wrangler pages deploy public --project-name=pikeandwest --branch=${{ github.head_ref || github.ref_name }} 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Wrangler deployment failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
          URL=$(echo "$OUTPUT" | grep -oE 'https://[a-z0-9-]+\.pikeandwest\.pages\.dev' | head -1)
          echo "deployment-url=$URL" >> $GITHUB_OUTPUT

      - name: Comment PR with Preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.deployment-url }}';
            const body = `ðŸš€ **Preview deployed!**\n\n${deploymentUrl}`;

            // Check for existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Preview deployed')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: Output deployment URL
        if: github.event_name == 'push'
        run: echo "Deployed to ${{ steps.deploy.outputs.deployment-url }}"

    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment-url }}

  lighthouse:
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        page:
          - { name: 'Homepage', path: '/' }
          - { name: 'About', path: '/about/' }
          - { name: 'Blog', path: '/blog/' }
          - { name: 'Contact', path: '/contact/' }
          - { name: 'Gallery Application', path: '/gallery-application/' }
    steps:
      - uses: actions/checkout@v4

      - name: Run Lighthouse
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ needs.deploy.outputs.deployment-url }}${{ matrix.page.path }}
          configPath: ./lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3

      - name: Save results
        run: |
          mkdir -p lighthouse-results
          echo '${{ steps.lighthouse.outputs.manifest }}' > lighthouse-results/${{ matrix.page.name }}.json
          echo '${{ steps.lighthouse.outputs.links }}' > lighthouse-results/${{ matrix.page.name }}-links.json

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-${{ matrix.page.name }}
          path: lighthouse-results/
          retention-days: 30

  lighthouse-summary:
    needs: [deploy, lighthouse]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Download all Lighthouse results
        uses: actions/download-artifact@v4
        with:
          pattern: lighthouse-*
          path: lighthouse-results/
          merge-multiple: true

      - name: Generate summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const resultsDir = 'lighthouse-results';
            const files = fs.readdirSync(resultsDir).filter(f => f.endsWith('.json') && !f.includes('-links'));

            let rows = [];
            let allPassed = true;

            for (const file of files) {
              const pageName = file.replace('.json', '');
              const manifest = JSON.parse(fs.readFileSync(path.join(resultsDir, file), 'utf8'));
              const linksFile = path.join(resultsDir, `${pageName}-links.json`);
              let reportLink = '';

              if (fs.existsSync(linksFile)) {
                try {
                  const links = JSON.parse(fs.readFileSync(linksFile, 'utf8'));
                  reportLink = Object.values(links)[0] || '';
                } catch (e) {
                  console.log('Could not parse links file:', e);
                }
              }

              if (manifest && manifest.length > 0) {
                const result = manifest[0];
                const summary = result.summary || {};

                const getScore = (key) => {
                  const score = summary[key];
                  if (score === undefined || score === null) return 'N/A';
                  const pct = Math.round(score * 100);
                  const emoji = pct >= 90 ? 'ðŸŸ¢' : pct >= 50 ? 'ðŸŸ ' : 'ðŸ”´';
                  if (pct < 90) allPassed = false;
                  return `${emoji} ${pct}`;
                };

                const pageLink = reportLink ? `[${pageName}](${reportLink})` : pageName;
                rows.push(`| ${pageLink} | ${getScore('performance')} | ${getScore('accessibility')} | ${getScore('best-practices')} | ${getScore('seo')} |`);
              }
            }

            const statusEmoji = allPassed ? 'âœ…' : 'âš ï¸';
            const statusText = allPassed ? 'All checks passed!' : 'Some scores below 90 threshold';

            const body = `## ${statusEmoji} Lighthouse Report

            ${statusText}

            | Page | Performance | Accessibility | Best Practices | SEO |
            |------|-------------|---------------|----------------|-----|
            ${rows.join('\n')}

            <details>
            <summary>Score Legend</summary>

            - ðŸŸ¢ 90-100: Good
            - ðŸŸ  50-89: Needs Improvement
            - ðŸ”´ 0-49: Poor

            </details>

            > Scores are median of 3 runs. [View full reports](https://googlechrome.github.io/lighthouse/viewer/) by clicking page names above.
            `;

            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Lighthouse Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
